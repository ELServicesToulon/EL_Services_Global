<script>
  /**
   * PiluleurManager - Gestionnaire de l'Assistant Contextuel
   * Implements the logic for the new React-based design using Vanilla JS.
   */
  const PiluleurManager = {
    // State
    state: {
      isOpen: false,
      currentContext: 'GÃ©nÃ©ral',
      lastClickX: 0,
      lastClickY: 0,
      isTyping: false
    },

    // DOM Elements
    dom: {},

    /**
     * Initialization
     */
    init: function() {
      // DOM References
      this.dom.chatWindowInner = document.querySelector('#chat-window > div');
      this.dom.fabContainer = document.getElementById('chat-fab-container');
      this.dom.messages = document.getElementById('chat-messages');
      this.dom.input = document.getElementById('chat-input');
      this.dom.sendBtn = document.getElementById('send-btn');
      this.dom.contextIndicator = document.getElementById('context-indicator');

      // Global Context Listener
      document.addEventListener('click', (e) => this.handleGlobalClick(e));

      console.log("ðŸ’Š Piluleur (Assistant ELS) initialized.");

      // Initial Welcome Message
      this.addMessage('model', "Bonjour ! Je suis l'assistant EL Services. Cliquez sur une zone de l'Ã©cran pour que je puisse vous aider contextuellement, ou posez-moi simplement votre question ci-dessous.");
    },

    /**
     * Handles global clicks for context detection.
     */
    handleGlobalClick: function(e) {
      // Ignore clicks inside the widget
      if (document.getElementById('els-piluleur-container').contains(e.target)) return;

      this.state.lastClickX = e.clientX;
      this.state.lastClickY = e.clientY;

      // Detect Context
      const newContext = this.detectContext(e.target);
      if (newContext !== this.state.currentContext) {
        this.state.currentContext = newContext;
        this.updateContextUI();
      }
    },

    /**
     * Context detection logic.
     */
    detectContext: function(target) {
      let context = 'GÃ©nÃ©ral';

      if (target.closest('#reservation-form') || target.closest('.reservation-step')) {
        context = 'RÃ©servation';
      } else if (target.closest('#facturation-table') || target.closest('.facture-row')) {
        context = 'Facturation';
      } else if (target.closest('.client-card') || target.closest('#client-search')) {
        context = 'Client';
      } else if (target.tagName === 'INPUT' || target.tagName === 'SELECT') {
        const label = target.previousElementSibling?.innerText || target.placeholder;
        if(label) context = `Champ : ${label.substring(0, 15)}...`;
      }

      return context;
    },

    /**
     * Updates the UI based on current context.
     */
    updateContextUI: function() {
      if (this.dom.contextIndicator) {
        this.dom.contextIndicator.innerText = this.state.currentContext;
        // Small flash animation
        this.dom.contextIndicator.classList.add('text-red-700');
        setTimeout(() => this.dom.contextIndicator.classList.remove('text-red-700'), 500);
      }
    },

    /**
     * Toggles the chat window.
     */
    toggleChat: function() {
      this.state.isOpen = !this.state.isOpen;
      this.renderState();
    },

    closeChat: function() {
      this.state.isOpen = false;
      this.renderState();
    },

    /**
     * Updates DOM classes based on state.isOpen
     */
    renderState: function() {
      if (this.state.isOpen) {
        // Show Window
        this.dom.chatWindowInner.classList.remove('scale-90', 'opacity-0', 'translate-y-10', 'h-0');
        this.dom.chatWindowInner.classList.add('scale-100', 'opacity-100', 'translate-y-0');

        // Hide FAB
        this.dom.fabContainer.classList.add('translate-y-20', 'opacity-0');
        this.dom.fabContainer.classList.remove('translate-y-0', 'opacity-100');

        setTimeout(() => this.dom.input.focus(), 300);
      } else {
        // Hide Window
        this.dom.chatWindowInner.classList.add('scale-90', 'opacity-0', 'translate-y-10', 'h-0');
        this.dom.chatWindowInner.classList.remove('scale-100', 'opacity-100', 'translate-y-0');

        // Show FAB
        this.dom.fabContainer.classList.remove('translate-y-20', 'opacity-0');
        this.dom.fabContainer.classList.add('translate-y-0', 'opacity-100');
      }
    },

    /**
     * Handles Enter key in input.
     */
    handleInputKey: function(e) {
      // Enable/Disable button based on input
      this.updateSendButtonState();

      if (e.key === 'Enter') {
        this.sendMessage();
      }
    },

    updateSendButtonState: function() {
        const val = this.dom.input.value.trim();
        if (val && !this.state.isTyping) {
            this.dom.sendBtn.classList.remove('bg-gray-300', 'scale-95', 'cursor-not-allowed');
            this.dom.sendBtn.classList.add('bg-red-600', 'hover:bg-red-700', 'scale-100');
            this.dom.sendBtn.disabled = false;
        } else {
            this.dom.sendBtn.classList.add('bg-gray-300', 'scale-95', 'cursor-not-allowed');
            this.dom.sendBtn.classList.remove('bg-red-600', 'hover:bg-red-700', 'scale-100');
            this.dom.sendBtn.disabled = true;
        }
    },

    /**
     * Sends the message.
     */
    sendMessage: function() {
      const text = this.dom.input.value.trim();
      if (!text || this.state.isTyping) return;

      // Add user message
      this.addMessage('user', text);
      this.dom.input.value = '';
      this.updateSendButtonState();

      // Set typing state
      this.state.isTyping = true;
      this.updateSendButtonState();
      const typingId = this.addTypingIndicator();

      // Call Backend
      google.script.run
        .withSuccessHandler((response) => {
          this.removeMessage(typingId);
          this.state.isTyping = false;
          this.updateSendButtonState();

          if (response && response.text) {
              this.addMessage('model', response.text);
          } else {
              this.addMessage('model', "Je n'ai pas reÃ§u de rÃ©ponse valide.");
          }
        })
        .withFailureHandler((err) => {
          this.removeMessage(typingId);
          this.state.isTyping = false;
          this.updateSendButtonState();
          this.addMessage('model', "Erreur : " + err.message);
        })
        .processChatRequest({
            message: text,
            context: this.state.currentContext,
            timestamp: new Date().toISOString()
        });
    },

    /**
     * Adds a message to the UI.
     * role: 'user' | 'model'
     */
    addMessage: function(role, text) {
      const div = document.createElement('div');
      div.className = `flex flex-col ${role === 'user' ? 'items-end' : 'items-start'} animate-fade-in`;

      const bubbleClass = role === 'user'
        ? 'bg-white border border-gray-200 text-gray-800 rounded-tr-none'
        : 'bg-white border-l-4 border-l-red-500 text-gray-700 rounded-tl-none italic';

      const label = role === 'user' ? 'Vous' : 'ELS';

      div.innerHTML = `
         <div class="max-w-[85%] rounded-2xl px-4 py-3 text-sm shadow-sm leading-relaxed ${bubbleClass}">
            ${text}
         </div>
         <span class="text-[10px] text-gray-400 mt-1 px-1">${label}</span>
      `;

      this.dom.messages.appendChild(div);
      this.scrollToBottom();
      return div;
    },

    addTypingIndicator: function() {
      const id = 'typing-' + Date.now();
      const div = document.createElement('div');
      div.id = id;
      div.className = "flex items-start animate-fade-in";
      div.innerHTML = `
        <div class="bg-white border-l-4 border-l-red-500 rounded-2xl rounded-tl-none px-4 py-3 shadow-sm">
            <div class="flex space-x-1">
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
            </div>
         </div>
      `;
      this.dom.messages.appendChild(div);
      this.scrollToBottom();
      return id;
    },

    removeMessage: function(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
    },

    scrollToBottom: function() {
      this.dom.messages.scrollTop = this.dom.messages.scrollHeight;
    }
  };

  // Initialize on load
  window.addEventListener('load', () => {
    setTimeout(() => PiluleurManager.init(), 500);
  });
</script>

<style>
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
}
.animate-fade-in {
    animation: fadeIn 0.3s ease-out forwards;
}
</style>
