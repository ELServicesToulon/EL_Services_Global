<script>
  /**
   * PiluleurManager - Gestionnaire de l'Assistant Contextuel
   * GÃ¨re la position de la gÃ©lule, le contexte et la communication
   */
  const PiluleurManager = {
    // Ã‰tat interne
    state: {
      isOpen: false,
      currentContext: 'GÃ©nÃ©ral',
      lastClickX: 0,
      lastClickY: 0,
      isDragging: false
    },

    // Elements DOM (initialisÃ©s dans init)
    dom: {},

    /**
     * Initialisation principale
     */
    init: function() {
      // RÃ©fÃ©rencement des Ã©lÃ©ments DOM
      this.dom.container = document.getElementById('els-piluleur-container');
      this.dom.window = document.getElementById('piluleur-window');
      this.dom.input = document.getElementById('chat-input');
      this.dom.messages = document.getElementById('chat-messages');
      this.dom.contextIndicator = document.getElementById('context-indicator');
      this.dom.label = document.getElementById('piluleur-label');

      // Ã‰couteur global pour le positionnement et le contexte
      document.addEventListener('click', (e) => this.handleGlobalClick(e));

      console.log("ðŸ’Š Piluleur (Assistant ELS) initialisÃ©.");

      // Message de bienvenue automatique
      this.addMessage('assistant', "Bonjour Emmanuel. Je suis prÃªt Ã  vous assister. Cliquez sur une section pour que je cible ma rÃ©ponse.");
    },

    /**
     * GÃ¨re les clics globaux sur la page
     * 1. DÃ©tecte le contexte (ex: clic sur un tableau de facture)
     * 2. DÃ©place la gÃ©lule Ã  proximitÃ© (si le chat est fermÃ©)
     */
    handleGlobalClick: function(e) {
      // Ignorer si clic DANS le piluleur
      if (this.dom.container.contains(e.target)) return;

      this.state.lastClickX = e.clientX;
      this.state.lastClickY = e.clientY;

      // 1. DÃ©tection du contexte
      const newContext = this.detectContext(e.target);
      if (newContext !== this.state.currentContext) {
        this.state.currentContext = newContext;
        this.updateContextUI();
      }

      // 2. DÃ©placement de la gÃ©lule (Seulement si chat fermÃ© pour ne pas gÃªner)
      if (!this.state.isOpen) {
        this.moveCapsuleNear(e.clientX, e.clientY);
      }
    },

    /**
     * Logique de dÃ©tection de contexte basÃ©e sur le DOM
     */
    detectContext: function(target) {
      let context = 'GÃ©nÃ©ral';

      // Recherche des indices dans les parents
      if (target.closest('#reservation-form') || target.closest('.reservation-step')) {
        context = 'RÃ©servation';
      } else if (target.closest('#facturation-table') || target.closest('.facture-row')) {
        context = 'Facturation';
      } else if (target.closest('.client-card') || target.closest('#client-search')) {
        context = 'Client';
      } else if (target.tagName === 'INPUT' || target.tagName === 'SELECT') {
        const label = target.previousElementSibling?.innerText || target.placeholder;
        if(label) context = `Champ : ${label.substring(0, 15)}...`;
      }

      return context;
    },

    /**
     * Met Ã  jour l'UI avec le nouveau contexte
     */
    updateContextUI: function() {
      if(this.dom.contextIndicator) {
        this.dom.contextIndicator.innerText = "Contexte : " + this.state.currentContext;
        // Animation lÃ©gÃ¨re pour signaler le changement
        this.dom.contextIndicator.style.color = '#D32F2F';
        setTimeout(() => this.dom.contextIndicator.style.color = '#666', 1000);
      }

      // Met Ã  jour le texte de la gÃ©lule
      if(this.dom.label) {
          this.dom.label.innerText = (this.state.currentContext === 'GÃ©nÃ©ral') ? 'Aide' : 'Aide ici';
      }
    },

    /**
     * DÃ©place la gÃ©lule Ã  une position ergonomique prÃ¨s du clic
     */
    moveCapsuleNear: function(x, y) {
      // Dimensions de la fenÃªtre
      const winW = window.innerWidth;
      const winH = window.innerHeight;

      // Marges de sÃ©curitÃ©
      const margin = 20;
      const capsuleW = 100; // approx
      const capsuleH = 44;

      // Position cible : 50px Ã  droite et 20px en bas du clic
      let targetX = x + 40;
      let targetY = y + 20;

      // Correction dÃ©bordement Droite
      if (targetX + capsuleW > winW) targetX = x - capsuleW - 20;
      // Correction dÃ©bordement Bas
      if (targetY + capsuleH > winH) targetY = y - capsuleH - 20;

      // Application
      this.dom.container.style.left = targetX + 'px';
      this.dom.container.style.top = targetY + 'px';
      this.dom.container.style.bottom = 'auto'; // DÃ©sactiver le bottom initial
      this.dom.container.style.right = 'auto';
    },

    /**
     * Ouvre/Ferme le chat
     */
    toggleChat: function() {
      this.state.isOpen = !this.state.isOpen;

      if (this.state.isOpen) {
        this.dom.window.classList.remove('hidden');
        // Focus sur l'input
        setTimeout(() => this.dom.input.focus(), 300);
        // Message d'accueil contextuel si vide
        if (this.dom.messages.children.length <= 1) { // 1 car message systÃ¨me
             // On pourrait ajouter un message automatique ici
        }
      } else {
        this.dom.window.classList.add('hidden');
      }
    },

    closeChat: function() {
      this.state.isOpen = false;
      this.dom.window.classList.add('hidden');
    },

    /**
     * Gestion de la touche EntrÃ©e
     */
    handleInputKey: function(e) {
      if (e.key === 'Enter') this.sendMessage();
    },

    /**
     * Envoi du message au backend
     */
    sendMessage: function() {
      const text = this.dom.input.value.trim();
      if (!text) return;

      // 1. Afficher message utilisateur
      this.addMessage('user', text);
      this.dom.input.value = '';

      // Indicateur de chargement
      const loadingId = this.addLoadingIndicator();

      // 2. Appel Backend avec le contexte
      // Note: On suppose que la fonction 'processChatRequest' existe dans Code_Piluleur.js
      // Sinon, il faudra l'ajouter.
      google.script.run
        .withSuccessHandler((response) => {
          this.removeMessage(loadingId);
          this.addMessage('assistant', response.text || "Je n'ai pas compris.");
        })
        .withFailureHandler((err) => {
          this.removeMessage(loadingId);
          this.addMessage('system', "Erreur de connexion : " + err.message);
        })
        .processChatRequest({
            message: text,
            context: this.state.currentContext,
            timestamp: new Date().toISOString()
        });
    },

    /**
     * Ajoute un message visuel
     */
    addMessage: function(type, text) {
      const div = document.createElement('div');
      div.className = `message ${type}`;
      div.innerHTML = `<div class="message-content">${text}</div>`;
      this.dom.messages.appendChild(div);
      this.scrollToBottom();
      return div.id = 'msg-' + Date.now();
    },

    addLoadingIndicator: function() {
      const id = 'loading-' + Date.now();
      const div = document.createElement('div');
      div.id = id;
      div.className = 'message assistant';
      div.innerHTML = `<div class="message-content"><i>RÃ©flexion en cours...</i></div>`;
      this.dom.messages.appendChild(div);
      this.scrollToBottom();
      return id;
    },

    removeMessage: function(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
    },

    scrollToBottom: function() {
      this.dom.messages.scrollTop = this.dom.messages.scrollHeight;
    }
  };

  // DÃ©marrage au chargement de la page
  window.addEventListener('load', () => {
    // Petit dÃ©lai pour laisser le temps au DOM principal de se charger
    setTimeout(() => PiluleurManager.init(), 500);
  });
</script>