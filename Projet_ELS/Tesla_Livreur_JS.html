<script>
(function() {
  var refs = {};
  var state = {
    timer: null
  };

  document.addEventListener('DOMContentLoaded', function() {
    refs = {
      refreshBtn: document.getElementById('btn-refresh'),
      forceBtn: document.getElementById('btn-force'),
      batteryLevel: document.getElementById('battery-level'),
      batteryBar: document.getElementById('battery-bar-fill'),
      batteryCard: document.querySelector('.card.battery'),
      threshold: document.getElementById('threshold'),
      batteryThreshold: document.getElementById('battery-threshold'),
      statusTag: document.getElementById('status-tag'),
      rangeKm: document.getElementById('range-km'),
      plugState: document.getElementById('plug-state'),
      chargeState: document.getElementById('charge-state'),
      minutesFull: document.getElementById('minutes-full'),
      advice: document.getElementById('advice-text'),
      lastUpdate: document.getElementById('last-update'),
      source: document.getElementById('source-tag'),
      error: document.getElementById('error-banner'),
      toast: document.getElementById('toast')
    };

    bindActions();
    refresh(false, false);
    state.timer = setInterval(function() {
      refresh(false, false);
    }, 60000);
  });

  window.addEventListener('beforeunload', function() {
    if (state.timer) {
      clearInterval(state.timer);
    }
  });

  function bindActions() {
    if (refs.refreshBtn) {
      refs.refreshBtn.addEventListener('click', function() {
        refresh(false, true);
      });
    }
    if (refs.forceBtn) {
      refs.forceBtn.addEventListener('click', function() {
        refresh(true, true);
      });
    }
  }

  function refresh(forceWake, manualTrigger) {
    setLoading(true);
    google.script.run
      .withSuccessHandler(function(res) {
        setLoading(false);
        handlePayload(res, manualTrigger, forceWake);
      })
      .withFailureHandler(function(err) {
        setLoading(false);
        showError('Erreur Apps Script: ' + (err && err.message ? err.message : 'inconnue'));
      })
      .getTeslaStatusForUI(Boolean(forceWake));
  }

  function handlePayload(payload, manualTrigger, forceWake) {
    if (!payload || payload.success !== true) {
      var message = (payload && payload.error) ? payload.error : 'Retour Tesla vide.';
      showError(message);
      return;
    }

    hideError();
    updateUI(payload);

    if (manualTrigger) {
      showToast(forceWake ? 'Reveil Tessie lance' : 'Etat Tesla mis a jour', 'success');
    }
  }

  function updateUI(payload) {
    var status = payload.status || {};
    var level = isFinite(status.batteryLevel) ? Number(status.batteryLevel) : null;
    var rangeKm = isFinite(status.rangeKm) ? Number(status.rangeKm) : null;
    var threshold = isFinite(payload.threshold) ? Number(payload.threshold) : null;

    if (refs.batteryLevel) {
      refs.batteryLevel.textContent = (level === null ? '--' : Math.round(level));
    }

    updateBatteryCard(level, threshold);

    if (refs.rangeKm) {
      refs.rangeKm.textContent = rangeKm === null ? '--' : Math.round(rangeKm);
    }

    if (refs.threshold) {
      refs.threshold.textContent = threshold === null ? '--%' : threshold + '%';
    }

    if (refs.chargeState) {
      refs.chargeState.textContent = describeChargeState(status.chargingState);
    }

    if (refs.plugState) {
      refs.plugState.textContent = status.isPlugged ? 'Cable detecte' : 'Non branche';
      refs.plugState.classList.toggle('pill', true);
      refs.plugState.classList.toggle('pill-muted', !status.isPlugged);
    }

    if (refs.minutesFull) {
      refs.minutesFull.textContent = formatMinutes(status.minutesToFull);
    }

    if (refs.statusTag) {
      refs.statusTag.textContent = status.chargingState ? status.chargingState : '--';
    }

    if (refs.advice) {
      refs.advice.textContent = payload.advice || 'Vehicule pret.';
    }

    if (refs.lastUpdate) {
      refs.lastUpdate.textContent = formatTimestamp(status.timestamp);
    }

    if (refs.source) {
      refs.source.textContent = payload.source === 'forced_refresh' ? 'Force (Tessie)' : 'Cache Tessie';
    }
  }

  function updateBatteryCard(level, threshold) {
    if (!refs.batteryBar || !refs.batteryCard) return;

    refs.batteryCard.classList.remove('warn', 'danger');

    if (level === null) {
      refs.batteryBar.style.width = '0%';
      if (refs.batteryThreshold) {
        refs.batteryThreshold.textContent = 'Batterie indisponible';
      }
      return;
    }

    refs.batteryBar.style.width = Math.max(0, Math.min(level, 100)) + '%';

    var warn = threshold ? level <= threshold : level <= 25;
    var danger = level <= Math.max(10, (threshold || 0) * 0.6);

    if (danger) {
      refs.batteryCard.classList.add('danger');
    } else if (warn) {
      refs.batteryCard.classList.add('warn');
    }

    if (refs.batteryThreshold) {
      refs.batteryThreshold.textContent = threshold ?
        'Alerte si < ' + threshold + '%' :
        'Seuil par defaut: 25%';
    }
  }

  function describeChargeState(state) {
    if (!state) return '--';
    var map = {
      Charging: 'En charge',
      Complete: 'Charge terminee',
      Disconnected: 'Non branche',
      Stopped: 'Charge arretee',
      Unknown: 'Statut inconnu'
    };
    return map[state] || state;
  }

  function formatMinutes(minutes) {
    if (!minutes && minutes !== 0) return '--';
    if (minutes < 60) {
      return '~' + Math.round(minutes) + ' min';
    }
    var hours = minutes / 60;
    return '~' + hours.toFixed(1) + ' h';
  }

  function formatTimestamp(ts) {
    if (!ts) return '--';
    try {
      var d = (ts instanceof Date) ? ts : new Date(ts);
      return d.toLocaleString('fr-FR', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' });
    } catch (_err) {
      return String(ts);
    }
  }

  function setLoading(isLoading) {
    if (refs.refreshBtn) {
      refs.refreshBtn.disabled = isLoading;
    }
    if (refs.forceBtn) {
      refs.forceBtn.disabled = isLoading;
    }
  }

  function showError(message) {
    if (refs.error) {
      refs.error.textContent = message || 'Erreur inconnue';
      refs.error.classList.remove('hidden');
    }
    showToast(message || 'Erreur', 'error');
  }

  function hideError() {
    if (refs.error) {
      refs.error.classList.add('hidden');
    }
  }

  function showToast(message, type) {
    if (!refs.toast) return;
    refs.toast.textContent = message;
    refs.toast.className = 'toast ' + (type || '');
    refs.toast.classList.remove('hidden');
    setTimeout(function() {
      refs.toast.classList.add('hidden');
    }, 2400);
  }
})();
</script>
