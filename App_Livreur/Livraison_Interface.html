<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ELS Livreur</title>
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom loader styles */
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3b82f6; /* Blue-500 */
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Hide scrollbar for clean mobile look */
    .no-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .no-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans h-screen flex flex-col overflow-hidden">

  <!-- =============================================================== -->
  <!-- LOGIN SCREEN (Nouveau) -->
  <!-- =============================================================== -->
  <div id="login-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gray-100 p-8 text-center">
    <h1 class="text-2xl font-bold text-blue-600 mb-2">üöö ELS Livreur</h1>
    <p class="text-gray-600 mb-8">Veuillez vous connecter pour continuer.</p>

    <div class="w-full max-w-sm">
      <input type="email" id="email-input" class="w-full px-4 py-3 border rounded-lg text-lg text-center focus:ring-2 focus:ring-blue-500 outline-none" placeholder="votre.email@example.com">
      <button onclick="app.handleLogin()" id="login-button" class="w-full mt-4 bg-blue-600 text-white py-3 rounded-lg font-bold shadow-md hover:bg-blue-700 transition-all active:scale-95">
        Se connecter
      </button>
      <div id="login-error" class="mt-4 text-red-500 font-medium text-sm h-5"></div>
    </div>

    <!-- Section "Candidature" (cach√©e par d√©faut) -->
    <div id="candidature-section" class="w-full max-w-sm mt-6 p-4 bg-white rounded-lg shadow-md hidden">
        <h3 class="font-bold text-gray-800">Acc√®s non autoris√©</h3>
        <p class="text-sm text-gray-600 mt-2">
            Votre email n'est pas reconnu. Si vous souhaitez devenir livreur pour ELS, veuillez envoyer votre candidature.
        </p>
        <a id="candidature-link" href="mailto:admin@example.com?subject=Candidature App Livreur" class="inline-block mt-4 bg-green-500 text-white px-5 py-2 rounded-lg font-semibold text-sm hover:bg-green-600">
            Envoyer ma candidature
        </a>
    </div>
  </div>


  <!-- APP SHELL: Loading Screen (Cach√© par d√©faut maintenant) -->
  <div id="app-loader" class="fixed inset-0 z-40 flex flex-col items-center justify-center bg-white hidden">
    <div class="loader mb-4"></div>
    <p class="text-gray-500 text-sm font-medium animate-pulse">Chargement ELS...</p>
  </div>

  <!-- APP CONTENT (Cach√© au d√©part) -->
  <div id="app-content" class="flex flex-col h-full hidden">

    <!-- HEADER -->
    <header class="bg-blue-600 text-white shadow-md z-10">
      <div class="flex items-center justify-between px-4 py-3">
        <h1 class="text-lg font-bold tracking-tight">üöö ELS Livreur</h1>
        <div class="flex space-x-2">
          <!-- Status Badges -->
          <span id="gps-badge" class="px-2 py-0.5 rounded text-xs font-mono bg-blue-700 opacity-50">GPS</span>
          <span id="sync-badge" class="px-2 py-0.5 rounded text-xs font-mono bg-green-500 text-white hidden">SYNC</span>
        </div>
      </div>
      <!-- Date & Scope Selector -->
      <div class="px-4 pb-3">
        <div class="flex justify-between items-center mb-1">
          <h2 id="current-date" class="text-sm font-medium opacity-90">...</h2>
        </div>
        <div class="flex bg-blue-700 rounded-lg p-1 text-xs font-medium">
          <button id="btn-day" class="flex-1 py-1 rounded text-center bg-white text-blue-700 shadow-sm transition-all" onclick="app.setScope('day')">Aujourd'hui</button>
          <button id="btn-week" class="flex-1 py-1 rounded text-center text-blue-100 hover:bg-blue-600 transition-all" onclick="app.setScope('week')">Semaine</button>
        </div>
      </div>
    </header>

    <!-- MAIN SCROLLABLE AREA -->
    <main class="flex-1 overflow-y-auto no-scrollbar p-4 space-y-4 relative" id="main-container">

      <!-- Stats Summary -->
      <div class="grid grid-cols-3 gap-3 mb-2">
        <div class="bg-white p-2 rounded shadow-sm text-center border-l-4 border-gray-300">
          <div id="stat-total" class="text-xl font-bold text-gray-700">-</div>
          <div class="text-[10px] uppercase text-gray-400 font-bold">Total</div>
        </div>
        <div class="bg-white p-2 rounded shadow-sm text-center border-l-4 border-green-500">
          <div id="stat-done" class="text-xl font-bold text-gray-700">-</div>
          <div class="text-[10px] uppercase text-gray-400 font-bold">Fait</div>
        </div>
        <div class="bg-white p-2 rounded shadow-sm text-center border-l-4 border-yellow-500">
          <div id="stat-todo" class="text-xl font-bold text-gray-700">-</div>
          <div class="text-[10px] uppercase text-gray-400 font-bold">√Ä faire</div>
        </div>
      </div>

      <!-- Tours List -->
      <div id="tours-list" class="space-y-3 pb-20">
        <!-- Les cartes de tourn√©es seront inject√©es ici -->
      </div>

    </main>

    <!-- FLOATING ACTION BUTTON (Note Rapide) -->
    <button onclick="app.openNotes()" class="absolute bottom-6 right-6 bg-blue-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-2xl z-20 hover:bg-blue-700 transition-transform active:scale-95">
      üìù
    </button>

  </div>

  <!-- MODAL / DRAWER: DETAIL & NOTES -->
  <div id="modal-notes" class="fixed inset-0 z-40 bg-black/50 hidden transition-opacity opacity-0" aria-hidden="true">
    <div class="absolute bottom-0 w-full bg-white rounded-t-xl shadow-2xl h-[85vh] flex flex-col transform transition-transform translate-y-full" id="modal-panel">

      <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
        <h3 class="font-bold text-gray-800" id="modal-title">Notes</h3>
        <button onclick="app.closeNotes()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
      </div>

      <div class="p-4 flex-1 overflow-y-auto">
        <!-- Info contextuelle -->
        <div id="modal-info" class="mb-4 text-sm text-gray-600 bg-blue-50 p-3 rounded border border-blue-100"></div>

        <!-- Saisie Note -->
        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Nouvelle Note</label>
        <textarea id="note-input" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-base mb-3" rows="3" placeholder="RAS, Absent, Code porte..."></textarea>

        <div class="flex space-x-2 mb-6">
          <button onclick="app.saveNote()" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-bold shadow active:bg-blue-700">Enregistrer</button>
          <button onclick="app.quickNote('Livr√© ‚úÖ')" class="px-4 bg-green-100 text-green-700 rounded-lg font-medium border border-green-200">‚úÖ Livr√©</button>
          <button onclick="app.quickNote('Absent ‚ùå')" class="px-4 bg-red-100 text-red-700 rounded-lg font-medium border border-red-200">‚ùå Absent</button>
        </div>

        <!-- Historique -->
        <h4 class="text-xs font-bold text-gray-500 uppercase mb-2 border-b pb-1">Historique</h4>
        <div id="notes-history" class="space-y-3">
          <!-- Historique inject√© ici -->
          <p class="text-gray-400 text-sm italic text-center py-4">Aucune note pour le moment.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- CLIENT LOGIC -->
  <script>
    /**
     * LOGIQUE CLIENT ELS LIVREUR (Optimis√©e)
     */
    const app = {
      state: {
        livreurId: null,
        tours: [],
        scope: 'day', // 'day' or 'week'
        loading: true,
        currentTourId: null
      },

      // NOUVELLE FONCTION: G√®re le clic sur le bouton de connexion
      handleLogin: function() {
        const emailInput = document.getElementById('email-input');
        const email = emailInput.value.trim().toLowerCase();
        const errorDiv = document.getElementById('login-error');
        const loginButton = document.getElementById('login-button');
        const candidatureSection = document.getElementById('candidature-section');

        // Validation simple de l'email
        if (!email || !email.includes('@')) {
          errorDiv.textContent = 'Veuillez entrer un email valide.';
          return;
        }

        // UI de chargement
        errorDiv.textContent = '';
        loginButton.disabled = true;
        loginButton.textContent = 'V√©rification...';
        candidatureSection.classList.add('hidden');

        // Appel au serveur pour v√©rifier l'email
        google.script.run
          .withSuccessHandler((response) => {
            if (response.success) {
              // Si la connexion r√©ussit, on lance le chargement de l'app
              this.init(response.livreur); // Lancer l'app
            } else {
              // Sinon, on affiche l'erreur et la section de candidature
              errorDiv.textContent = response.error;
              this.showCandidatureForm(response.adminEmail); // On passe l'email admin re√ßu
              loginButton.disabled = false;
              loginButton.textContent = 'Se connecter';
            }
          })
          .withFailureHandler((err) => {
            errorDiv.textContent = 'Une erreur technique est survenue.';
            console.error('Login failed:', err);
            loginButton.disabled = false;
            loginButton.textContent = 'Se connecter';
          })
          .verifierLivreur(email);
      },

      // NOUVELLE FONCTION: Affiche la section de candidature
      showCandidatureForm: function(adminEmail) {
        const candidatureSection = document.getElementById('candidature-section');
        const mailtoLink = document.getElementById('candidature-link');

        // L'email est maintenant dynamique
        const email = adminEmail || 'contact@example.com'; // Fallback au cas o√π
        mailtoLink.href = `mailto:${email}?subject=Candidature App Livreur`;

        candidatureSection.classList.remove('hidden');
      },

      // `init` est maintenant appel√© APR√àS la connexion r√©ussie
      init: function(livreurInfo) {
        console.log('App init for livreur:', livreurInfo.id);

        // On masque l'√©cran de login et on affiche le loader
        document.getElementById('login-screen').classList.add('hidden');
        this.showLoader(true);

        // Appel Serveur asynchrone pour les donn√©es de l'app
        google.script.run
          .withSuccessHandler(this.onDataLoaded.bind(this))
          .withFailureHandler(this.onError.bind(this))
          // On passe l'ID du livreur pour ne charger que ses tourn√©es
          .getInitialData({ livreur: livreurInfo.id });
      },

      onDataLoaded: function(data) {
        console.log('Data loaded:', data);
        if (!data.success) {
          alert('Erreur serveur: ' + data.error);
          return;
        }

        this.state.livreurId = data.livreur.id;
        this.state.tours = data.toursData.tournees || [];

        // Update UI
        this.renderDate();
        this.renderTours();
        this.updateStats();

        // Hide Loader, Show Content
        document.getElementById('app-loader').classList.add('hidden');
        document.getElementById('app-content').classList.remove('hidden');
        this.state.loading = false;

        // Setup GPS
        this.initGPS();
      },

      onError: function(err) {
        console.error(err);
        document.querySelector('#app-loader p').textContent = "Erreur de chargement. R√©essayez.";
        document.querySelector('#app-loader p').classList.add('text-red-500');
      },

      setScope: function(scope) {
        if (this.state.scope === scope) return;
        this.state.scope = scope;

        // Update Buttons
        const btnDay = document.getElementById('btn-day');
        const btnWeek = document.getElementById('btn-week');

        if (scope === 'day') {
          btnDay.className = "flex-1 py-1 rounded text-center bg-white text-blue-700 shadow-sm transition-all";
          btnWeek.className = "flex-1 py-1 rounded text-center text-blue-100 hover:bg-blue-600 transition-all";
        } else {
          btnDay.className = "flex-1 py-1 rounded text-center text-blue-100 hover:bg-blue-600 transition-all";
          btnWeek.className = "flex-1 py-1 rounded text-center bg-white text-blue-700 shadow-sm transition-all";
        }

        // Re-fetch or filter? Pour l'instant on re-fetch pour √™tre s√ªr (simple)
        // Ou mieux : on a d√©j√† charg√© 'day', si on veut week faut rappeler le serveur si on a pas tout.
        // Optimisation V2: Tout charger au d√©but ou cache.
        // Ici on relance un appel l√©ger
        this.showLoader(true);
        google.script.run
          .withSuccessHandler((res) => {
             this.state.tours = res.tournees;
             this.renderDate();
             this.renderTours();
             this.updateStats();
             this.showLoader(false);
          })
          .obtenirTournees({ scope: scope, livreurId: this.state.livreurId });
      },

      renderDate: function() {
        const d = new Date();
        const options = { weekday: 'long', day: 'numeric', month: 'long' };
        document.getElementById('current-date').textContent = d.toLocaleDateString('fr-FR', options);
      },

      renderTours: function() {
        const container = document.getElementById('tours-list');
        container.innerHTML = '';

        if (this.state.tours.length === 0) {
          container.innerHTML = `
            <div class="flex flex-col items-center justify-center py-10 opacity-50">
              <span class="text-4xl mb-2">üì≠</span>
              <p>Aucune tourn√©e pr√©vue.</p>
            </div>`;
          return;
        }

        this.state.tours.forEach(t => {
          const statusColors = {
            'a_venir': 'border-l-blue-500',
            'en_cours': 'border-l-yellow-500 bg-yellow-50',
            'termine': 'border-l-green-500 opacity-60',
            'probleme': 'border-l-red-500'
          };
          const borderClass = statusColors[t.statut] || 'border-l-gray-300';

          const el = document.createElement('div');
          el.className = `bg-white p-4 rounded-lg shadow-sm border-l-4 ${borderClass} relative active:scale-[0.99] transition-transform`;
          el.onclick = () => this.openNotes(t.id);

          el.innerHTML = `
            <div class="flex justify-between items-start mb-1">
              <span class="font-bold text-lg text-gray-800">${t.heure}</span>
              <span class="text-xs font-bold uppercase px-2 py-1 rounded bg-gray-100 text-gray-600">${this.formatStatus(t.statut)}</span>
            </div>
            <h3 class="font-semibold text-gray-900 leading-tight">${t.client}</h3>
            <p class="text-gray-500 text-sm truncate mb-2">${t.adresse}</p>

            <div class="flex justify-between items-center mt-3 pt-2 border-t border-gray-100">
              <div class="text-xs text-gray-400 font-mono">ID: ${t.id}</div>
              <div class="flex space-x-2">
                 ${this.renderActionButtons(t)}
              </div>
            </div>
          `;
          container.appendChild(el);
        });
      },

      renderActionButtons: function(t) {
        // Boutons d'action rapide selon le statut
        if (t.statut === 'a_venir') {
          return `<button onclick="event.stopPropagation(); app.setStatus('${t.id}', 'en_cours')" class="text-xs bg-blue-600 text-white px-3 py-1.5 rounded font-bold shadow-sm">D√©part üöÄ</button>`;
        } else if (t.statut === 'en_cours') {
          return `<button onclick="event.stopPropagation(); app.setStatus('${t.id}', 'termine')" class="text-xs bg-green-600 text-white px-3 py-1.5 rounded font-bold shadow-sm">Terminer ‚úÖ</button>`;
        }
        return `<span class="text-xs text-gray-400 italic">Termin√©</span>`;
      },

      formatStatus: function(s) {
        const map = { 'a_venir': '√Ä venir', 'en_cours': 'En cours', 'termine': 'Termin√©', 'probleme': 'Probl√®me' };
        return map[s] || s;
      },

      updateStats: function() {
        const total = this.state.tours.length;
        const done = this.state.tours.filter(t => t.statut === 'termine').length;
        const todo = total - done;

        document.getElementById('stat-total').textContent = total;
        document.getElementById('stat-done').textContent = done;
        document.getElementById('stat-todo').textContent = todo;
      },

      setStatus: function(id, newStatus) {
        // Optimistic UI update
        const t = this.state.tours.find(x => x.id === id);
        if (t) {
          t.statut = newStatus;
          this.renderTours();
          this.updateStats();

          // Server call
          google.script.run.mettreAJourStatutTournee(id, newStatus, this.state.livreurId);
        }
      },

      // --- NOTES & MODAL ---

      openNotes: function(tourId) {
        const modal = document.getElementById('modal-notes');
        const panel = document.getElementById('modal-panel');
        const info = document.getElementById('modal-info');

        this.state.currentTourId = tourId || null;

        // Reset input
        document.getElementById('note-input').value = '';

        if (tourId) {
          const t = this.state.tours.find(x => x.id === tourId);
          info.innerHTML = `<strong>${t.client}</strong><br>${t.adresse}`;
          info.classList.remove('hidden');
          this.loadHistory(tourId);
        } else {
          info.innerHTML = 'Note g√©n√©rale (hors tourn√©e)';
          info.classList.remove('hidden');
          document.getElementById('notes-history').innerHTML = '';
        }

        modal.classList.remove('hidden');
        // Small delay for transition
        setTimeout(() => {
          modal.classList.remove('opacity-0');
          panel.classList.remove('translate-y-full');
        }, 10);
      },

      closeNotes: function() {
        const modal = document.getElementById('modal-notes');
        const panel = document.getElementById('modal-panel');

        panel.classList.add('translate-y-full');
        modal.classList.add('opacity-0');
        setTimeout(() => {
          modal.classList.add('hidden');
        }, 300);
      },

      saveNote: function() {
        const txt = document.getElementById('note-input').value.trim();
        if (!txt) return;

        const noteData = {
          tourneeId: this.state.currentTourId || 'GENERAL',
          texte: txt,
          livreurId: this.state.livreurId
          // TODO: Add GPS coords here
        };

        // Optimistic append to history if viewing specific tour
        if (this.state.currentTourId) {
          const hist = document.getElementById('notes-history');
          const div = document.createElement('div');
          div.className = "bg-gray-50 p-2 rounded text-sm border-l-2 border-blue-400";
          div.innerHTML = `<div class="font-bold text-xs text-gray-500">√Ä l'instant</div><div>${txt}</div>`;
          hist.prepend(div);
        }

        google.script.run.sauvegarderNote(noteData);
        document.getElementById('note-input').value = '';
      },

      quickNote: function(text) {
        document.getElementById('note-input').value = text;
        this.saveNote();
      },

      loadHistory: function(tourId) {
        const container = document.getElementById('notes-history');
        container.innerHTML = '<div class="text-center text-gray-400 text-xs animate-pulse">Chargement...</div>';

        google.script.run
          .withSuccessHandler((res) => {
            container.innerHTML = '';
            if (!res.success || !res.notes.length) {
              container.innerHTML = '<p class="text-gray-400 text-sm italic text-center py-2">Aucune note.</p>';
              return;
            }
            res.notes.forEach(n => {
              const div = document.createElement('div');
              div.className = "bg-gray-50 p-2 rounded text-sm border-l-2 border-gray-300";
              const dateStr = new Date(n.timestamp).toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
              div.innerHTML = `<div class="font-bold text-xs text-gray-500">${dateStr}</div><div>${n.texte}</div>`;
              container.appendChild(div);
            });
          })
          .obtenirNotesTournee({ tourneeId: tourId });
      },

      // --- UTILS ---

      showLoader: function(show) {
        const l = document.getElementById('app-loader');
        if (show) l.classList.remove('hidden');
        else l.classList.add('hidden');
      },

      initGPS: function() {
        if ("geolocation" in navigator) {
          navigator.geolocation.watchPosition(
            (pos) => {
              const b = document.getElementById('gps-badge');
              b.classList.remove('opacity-50', 'bg-red-500');
              b.classList.add('bg-green-500'); // Active
              // Store pos for next note
              this.state.lastPos = pos.coords;
            },
            (err) => {
              const b = document.getElementById('gps-badge');
              b.classList.add('bg-red-500', 'opacity-100');
            },
            { enableHighAccuracy: true }
          );
        }
      }
    };

    // Start: On n'appelle plus init() automatiquement.
    // L'utilisateur doit cliquer sur "Se connecter" via app.handleLogin().
    window.onload = function() {
      // L'app est pr√™te √† recevoir l'action de l'utilisateur.
      console.log('Login screen ready.');
      document.getElementById('email-input').focus(); // Focus sur le champ email
    };
  </script>
</body>
</html>
