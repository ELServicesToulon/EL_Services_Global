<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <title>EL Services Livreur</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f4;
      }
      .container {
        padding: 15px;
      }
      .header {
        background-color: #004d40;
        color: white;
        padding: 15px;
        text-align: center;
        margin-bottom: 20px;
      }
      .tournee-card {
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 8px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .tournee-header {
        background-color: #00796b;
        color: white;
        padding: 10px;
        border-radius: 8px 8px 0 0;
        font-weight: bold;
      }
      .arret-details {
        padding: 10px;
        border-bottom: 1px solid #eee;
      }
      .arret-details:last-child {
        border-bottom: none;
      }
      .arret-status {
        font-weight: bold;
        color: #d32f2f; /* Rouge par défaut */
        margin-top: 5px;
      }
      .status-Livrée { color: #388e3c; } /* Vert */
      .status-À_livrer { color: #fbc02d; } /* Jaune */

      .input-group {
        margin-top: 10px;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      
      /* CORRECTION TESLA: Augmentation de la cible tactile pour la fiabilité */
      .input-group button, .input-group textarea, .input-group input[type="submit"] {
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ccc;
        min-height: 44px; /* Taille minimale recommandée pour le tactile */
      }
      
      .btn-ras {
        background-color: #4CAF50; /* Vert */
        color: white;
        border: none;
        cursor: pointer;
      }
      .btn-submit {
        background-color: #1976d2; /* Bleu */
        color: white;
        border: none;
        cursor: pointer;
        margin-top: 10px;
      }
      .btn-ras:hover {
        background-color: #45a049;
      }
      .btn-submit:hover {
        background-color: #1565c0;
      }
      .note-field {
        resize: vertical;
        min-height: 44px; /* Ajusté à 44px */
      }
      .loading {
        text-align: center;
        padding: 20px;
        font-size: 1.2em;
        color: #004d40;
      }
      
      /* Si le "menu déroulant" était un élément sélecteur (&lt;select&gt;), le CSS suivant est essentiel */
      select {
          -webkit-appearance: none; /* Désactive le style natif iOS/Android qui peut bugger */
          appearance: none;
          padding-right: 30px; /* Espace pour une flèche custom si nécessaire */
      }
    </style>
  </head>
  <body>
    <div class="header">
      Application Livreur ELS
    </div>

    <div class="container">
      <div id="tournees-list">
        <div class="loading">Chargement des tournées...</div>
      </div>
    </div>

    <script>
      // Variables globales (remplacez par l'email réel après authentification)
      // NOTE DU DEVELOPPEUR: Ces valeurs sont en dur (CHAUFFEUR_EMAIL, CHAUFFEUR_ID)
      // et doivent IMPERATIVEMENT être remplacées par un mécanisme de PropertiesService
      // et d'authentification SECURISEE (OAuth, Token) pour respecter la Règle 2.
      const CHAUFFEUR_EMAIL = 'maning2@hotmail.com'; // À remplacer par un mécanisme d'authentification réel
      const CHAUFFEUR_ID = 'LIV-101'; // À remplacer par l'ID réel après authentification

      /**
       * Initialise l'application en chargeant les tournées.
       */
      function initApp() {
        loadTournees();
      }

      /**
       * Appelle le serveur pour obtenir la liste des tournées.
       */
      function loadTournees() {
        google.script.run
          .withSuccessHandler(renderTournees)
          .withFailureHandler(handleError)
          .getListeTournees(CHAUFFEUR_EMAIL);
      }

      /**
       * Gère les erreurs du côté serveur.
       * @param {string} error L'objet d'erreur.
       */
      function handleError(error) {
        console.error("Erreur serveur :", error);
        const listDiv = document.getElementById('tournees-list');
        listDiv.innerHTML = `<p style="color: red; text-align: center;">Erreur de chargement: ${error.message || error.toString()}</p>`;
      }
      
      /**
       * Envoie les données de statut de livraison au serveur.
       * @param {string} tourneeId L'ID de la tournée (Event ID).
       * @param {string} livraisonId L'ID unique de l'arrêt.
       * @param {string} status Le nouveau statut (e.g., 'Livrée', 'Problème').
       * @param {string} note La note ou anomalie.
       * @param {string} arretDivId L'ID du div d'arrêt dans l'interface pour la mise à jour.
       */
      function updateLivraisonStatus(tourneeId, livraisonId, status, note, arretDivId) {
        const payload = {
          tournee_id: tourneeId,
          livraison_id: livraisonId,
          ehpad_id: livraisonId, // Simplification: on utilise l'ID de livraison comme ID d'établissement pour la traçabilité
          chauffeur_id: CHAUFFEUR_ID,
          status: status,
          anomalie_code: status === 'Livrée' ? 'RAS' : 'ANOMALIE',
          anomalie_note: note,
          // Ajout des coordonnées GPS réelles si l'API de géolocalisation était active
          gps_lat: '', 
          gps_lng: '',
          app_version: '1.0'
        };

        google.script.run
          .withSuccessHandler((response) => {
            if (response.success) {
              updateUI(arretDivId, status);
            } else {
              alert("Erreur lors de l'enregistrement: " + response.message);
            }
          })
          .withFailureHandler(handleError)
          .enregistrerStatutLivraison(payload);
      }

    </script>

    <script>
      // Création de la liste des tournées et de leurs arrêts
      function renderTournees(tournees) {
        const listDiv = document.getElementById('tournees-list');
        listDiv.innerHTML = ''; // Nettoyer la liste

        if (tournees.length === 0) {
          listDiv.innerHTML = '<p style="text-align: center; color: #777;">Aucune tournée trouvée pour aujourd\'hui.</p>';
          return;
        }

        tournees.forEach((tournee, index) => {
          const card = document.createElement('div');
          card.className = 'tournee-card';

          const header = document.createElement('div');
          header.className = 'tournee-header';
          header.textContent = `Tournée: ${tournee.client_nom} (${tournee.arrets.length} arrêts)`;
          card.appendChild(header);

          tournee.arrets.forEach((arret, arretIndex) => {
            const arretDiv = document.createElement('div');
            arretDiv.className = 'arret-details';
            arretDiv.id = `arret-${arret.livraison_id}`;

            const nomArret = document.createElement('strong');
            nomArret.textContent = `${arret.nom} (${arret.type_arret})`;
            arretDiv.appendChild(nomArret);

            const statusP = document.createElement('p');
            statusP.className = `arret-status status-${arret.status.replace(/[^a-zA-Z0-9]/g, '_')}`;
            statusP.innerHTML = `Statut actuel: <span>${arret.status}</span>`;
            arretDiv.appendChild(statusP);

            const inputGroup = document.createElement('div');
            inputGroup.className = 'input-group';

            // Bouton RAS
            const btnRas = document.createElement('button');
            btnRas.className = 'btn-ras';
            btnRas.textContent = 'Marquer RAS (Rien À Signaler)';
            btnRas.onclick = () => {
              document.getElementById(`note-${arret.livraison_id}`).value = 'RAS';
              updateLivraisonStatus(tournee.event_id, arret.livraison_id, 'Livrée', 'RAS', `arret-${arret.livraison_id}`);
            };
            inputGroup.appendChild(btnRas);

            // Champ de Note
            const noteTextarea = document.createElement('textarea');
            noteTextarea.id = `note-${arret.livraison_id}`;
            noteTextarea.className = 'note-field';
            noteTextarea.placeholder = 'Note / Anomalie (optionnel)';
            noteTextarea.value = arret.note || ''; // Pré-remplir avec la note existante
            inputGroup.appendChild(noteTextarea);

            // Bouton Soumettre avec Note/Anomalie
            const btnSubmit = document.createElement('button');
            btnSubmit.className = 'btn-submit';
            btnSubmit.textContent = 'Soumettre Note / Anomalie';
            btnSubmit.onclick = () => {
              const note = document.getElementById(`note-${arret.livraison_id}`).value;
              const status = note.toUpperCase().includes('RAS') ? 'Livrée' : 'Problème';
              updateLivraisonStatus(tournee.event_id, arret.livraison_id, status, note, `arret-${arret.livraison_id}`);
            };
            inputGroup.appendChild(btnSubmit);

            arretDiv.appendChild(inputGroup);
            card.appendChild(arretDiv);
          });

          listDiv.appendChild(card);
        });
      }
      
      // Fonction pour mettre à jour l'affichage après l'enregistrement
      function updateUI(arretId, newStatus) {
        const arretDiv = document.getElementById(arretId);
        if (arretDiv) {
          const statusSpan = arretDiv.querySelector('.arret-status span');
          if (statusSpan) {
            // Mise à jour de la classe pour la couleur
            const oldClasses = Array.from(arretDiv.querySelector('.arret-status').classList).filter(c => c.startsWith('status-'));
            arretDiv.querySelector('.arret-status').classList.remove(...oldClasses);
            arretDiv.querySelector('.arret-status').classList.add(`status-${newStatus.replace(/[^a-zA-Z0-9]/g, '_')}`);
            
            // Mise à jour du texte
            statusSpan.textContent = newStatus;
          }
          alert(`Statut mis à jour pour l'arrêt ${arretId} : ${newStatus}`);
        }
      }

      // Initialisation après le chargement du corps
      document.addEventListener('DOMContentLoaded', initApp);
    </script>
  </body>
</html>