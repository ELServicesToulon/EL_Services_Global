<script>
/**
 * =================================================================
 * MODULE JAVASCRIPT - PRINCIPAL
 * =================================================================
 * Description: Point d'entrÃ©e principal du script cÃ´tÃ© client.
 * Initialise l'Ã©tat de l'application, configure les Ã©couteurs
 * d'Ã©vÃ©nements et lance l'affichage initial.
 */

/**
 * Initialise les drapeaux avec des valeurs par dÃ©faut et les fusionne avec ceux fournis.
 * @param {Object} [flags={}] Drapeaux provenant du serveur.
 * @returns {Object} Objet de drapeaux complÃ©tÃ©.
 */
function initializeFlags(flags = {}) {
  const defaults = {
    clientPortalEnabled: false,
    clientPortalSignedLinks: false,
    privacyLinkEnabled: false,
    legalNoticeEnabled: false,
    slotsAmpmEnabled: false,
    adresseAutocompleteEnabled: false,
    billingMultiSheetEnabled: false,
    caEnCoursEnabled: false,
    calendarResyncEnabled: false,
    calendarPurgeEnabled: false,
    calendarBarOpacityEnabled: false,
    reservationUiV2Enabled: false,
    residentBillingEnabled: false,
    billingModalEnabled: false,
    debugMenuEnabled: false,
    demoReservationEnabled: false,
    billingV2Dryrun: false,
    requestLoggingEnabled: false,
    postEndpointEnabled: false,
    configCacheEnabled: false,
      reservationCacheEnabled: false,
      reservationShowTakenSlotsEnabled: false,
      themeV2Enabled: false,
      themeSwitcherEnabled: false,
    elsUiThemingEnabled: false,
    cartResetEnabled: false,
    devisEnabled: false

  };
  return Object.assign({}, defaults, flags);
}

const CLE_LOCALSTORAGE_CODE_POSTAL = 'ELS_CODE_POSTAL_OFFICINE';
const CLE_THEME_PREFERENCE = 'ELS_THEME_CHOICE';
const THEMES = Object.freeze({
  IMMERSIVE: 'immersive',
  ULTRA: 'ultra'
});
let releaseCodePostalFocus = () => {};

// Ã‰tat global de l'application cÃ´tÃ© client
window.etat = {
  dateActuelle: new Date(),
  panier: [],
  tourneeEnCours: {}, // Sera peuplÃ© lors de la configuration
  clientReconnu: null,
  codePostalOfficine: '',
  adresseSuggestion: null,
  flags: initializeFlags() // Flags d'activation issus de Configuration.gs
};

function lireThemePreference() {
  try {
    return localStorage.getItem(CLE_THEME_PREFERENCE) || '';
  } catch (_err) {
    return '';
  }
}

function mettreAJourThemeUI(theme) {
  const isUltra = theme === THEMES.ULTRA;
  const btn = window.ui?.btnThemeSwitch;
  const label = window.ui?.themeSwitchLabel;
  if (btn) {
    btn.textContent = isUltra ? 'Revenir au thÃ¨me immersif' : 'Activer le thÃ¨me rapide';
    btn.setAttribute('aria-pressed', isUltra ? 'true' : 'false');
    btn.dataset.nextTheme = isUltra ? THEMES.IMMERSIVE : THEMES.ULTRA;
  }
  if (label) {
    label.textContent = isUltra ? 'ThÃ¨me actuel : rapide' : 'ThÃ¨me actuel : immersif';
  }
}

function appliquerThemeClient(theme, options = {}) {
  const cible = theme === THEMES.ULTRA ? THEMES.ULTRA : THEMES.IMMERSIVE;
  const body = document.body;
  if (!body) return;

  if (cible === THEMES.ULTRA) {
    body.classList.add('theme-ultra');
    body.classList.remove('els-aluminium');
  } else {
    body.classList.remove('theme-ultra');
    if (window.etat?.flags?.elsUiThemingEnabled) {
      body.classList.add('els-aluminium');
    }
  }
  mettreAJourThemeUI(cible);
  if (options.persist !== false) {
    try {
      localStorage.setItem(CLE_THEME_PREFERENCE, cible);
    } catch (_err) {
      // ignore storage errors (navigation privÃ©e, etc.)
    }
  }
}

function basculerTheme() {
  const body = document.body;
  if (!body) return;
  const prochain = body.classList.contains('theme-ultra') ? THEMES.IMMERSIVE : THEMES.ULTRA;
  appliquerThemeClient(prochain);
}

function initialiserThemeSwitcher() {
  const flags = window.etat?.flags || {};
  const container = window.ui?.themeSwitcherContainer;
  if (!flags.themeSwitcherEnabled) {
    if (container) {
      if (typeof container.remove === 'function') {
        container.remove();
      } else if (container.parentNode) {
        container.parentNode.removeChild(container);
      }
    }
    appliquerThemeClient(THEMES.IMMERSIVE, { persist: false });
    try {
      localStorage.removeItem(CLE_THEME_PREFERENCE);
    } catch (_err) {
      // ignore storage errors
    }
    return;
  }

  const btn = window.ui?.btnThemeSwitch;
  if (!btn) return;

  const stored = lireThemePreference();
  const initialTheme = stored === THEMES.ULTRA ? THEMES.ULTRA : THEMES.IMMERSIVE;
  appliquerThemeClient(initialTheme, { persist: false });
  btn.removeEventListener('click', basculerTheme);
  btn.addEventListener('click', basculerTheme);
}

function estForfaitResidentActif() {
  return !!(configServeur?.FORFAIT_RESIDENT_ENABLED && window.ui?.champResidentClient?.checked);
}

function obtenirModeResident() {
  if (!estForfaitResidentActif()) return 'standard';
  const radios = window.ui?.residentModeRadios || [];
  const active = radios.find(radio => radio.checked);
  return active?.value === 'urgence' ? 'urgence' : 'standard';
}

function obtenirLibelleResident(mode) {
  return mode === 'urgence' ? 'Forfait rÃ©sident - Urgence' : 'Forfait rÃ©sident - Standard';
}

function obtenirPrixResident(mode) {
  const standard = Number(configServeur?.FORFAIT_RESIDENT_STANDARD);
  const urgence = Number(configServeur?.FORFAIT_RESIDENT_URGENCE);
  if (mode === 'urgence' && Number.isFinite(urgence)) return urgence;
  if (Number.isFinite(standard)) return standard;
  return null;
}

window.estForfaitResidentActif = estForfaitResidentActif;
window.obtenirModeResident = obtenirModeResident;
window.obtenirPrixResident = obtenirPrixResident;
window.obtenirLibelleResident = obtenirLibelleResident;

function emettreEvenementCodePostal(code) {
  try {
    document.dispatchEvent(new CustomEvent('els-code-postal-change', { detail: code || '' }));
  } catch (_err) {
    // CustomEvent non supportÃ© (IE11); on ignore simplement.
  }
}

function normaliserCodePostalLocal(valeur) {
  if (valeur === null || valeur === undefined) return '';
  const digits = String(valeur).replace(/\D/g, '');
  return digits.length === 5 ? digits : '';
}

function normaliserTelephoneLocal(valeur) {
  if (valeur === null || valeur === undefined) return '';
  return String(valeur).replace(/\s+/g, ' ').trim();
}

function telephoneValideLocal(valeur) {
  const digits = String(valeur || '').replace(/\D/g, '');
  return digits.length >= 10;
}

function lireCodePostalStocke() {
  try {
    return localStorage.getItem(CLE_LOCALSTORAGE_CODE_POSTAL) || '';
  } catch (_e) {
    return '';
  }
}

function enregistrerCodePostalStocke(code) {
  if (!code) return;
  try {
    localStorage.setItem(CLE_LOCALSTORAGE_CODE_POSTAL, code);
  } catch (_e) {
    // ignore storage errors (navigation privÃ©e, etc.)
  }
}

function effacerCodePostalStocke() {
  try {
    localStorage.removeItem(CLE_LOCALSTORAGE_CODE_POSTAL);
  } catch (_e) {
    // ignore
  }
}

function definirCodePostalCourant(code, options = {}) {
  const normalise = normaliserCodePostalLocal(code);
  if (!normalise) {
    if (options.forceClear === true) {
      window.etat.codePostalOfficine = '';
      if (!options.skipStorage) {
        effacerCodePostalStocke();
      }
      if (window.ui?.champCodePostalClient) {
        window.ui.champCodePostalClient.value = '';
      }
      emettreEvenementCodePostal('');
    }
    return '';
  }
  window.etat.codePostalOfficine = normalise;
  if (!options.skipStorage) {
    enregistrerCodePostalStocke(normalise);
  }
  if (window.ui?.champCodePostalClient) {
    window.ui.champCodePostalClient.value = normalise;
    window.ui.champCodePostalClient.readOnly = true;
  }
  if (window.ui?.champCodePostalOverlay) {
    window.ui.champCodePostalOverlay.value = normalise;
  }
  if (window.etat?.clientReconnu) {
    window.etat.clientReconnu.codePostal = normalise;
  }
  cacherErreurCodePostal();
  emettreEvenementCodePostal(normalise);
  return normalise;
}

function obtenirCodePostalCourant() {
  if (window.etat.codePostalOfficine) {
    return window.etat.codePostalOfficine;
  }
  const valeurChamp = window.ui?.champCodePostalClient?.value;
  const normalise = normaliserCodePostalLocal(valeurChamp);
  if (normalise) {
    window.etat.codePostalOfficine = normalise;
    enregistrerCodePostalStocke(normalise);
  }
  return normalise;
}

function afficherErreurCodePostal(message) {
  const el = window.ui?.messageCodePostalErreur;
  if (!el) return;
  el.textContent = message || '';
  el.classList.toggle('hidden', !message);
}

function cacherErreurCodePostal() {
  afficherErreurCodePostal('');
}

function afficherVerrouCodePostal(message) {
  const overlay = window.ui?.codePostalOverlay;
  if (!overlay) return;
  overlay.classList.remove('hidden');
  overlay.setAttribute('aria-hidden', 'false');
  if (typeof trapFocus === 'function') {
    releaseCodePostalFocus = trapFocus(overlay);
  }
  const input = window.ui?.champCodePostalOverlay;
  if (input) {
    const valeur = window.etat.codePostalOfficine || lireCodePostalStocke();
    if (valeur) {
      input.value = valeur;
    }
    setTimeout(() => input.focus(), 0);
  }
  if (message) {
    afficherErreurCodePostal(message);
  } else {
    cacherErreurCodePostal();
  }
}

function masquerVerrouCodePostal() {
  const overlay = window.ui?.codePostalOverlay;
  if (!overlay) return;
  overlay.classList.add('hidden');
  overlay.setAttribute('aria-hidden', 'true');
  releaseCodePostalFocus();
  releaseCodePostalFocus = () => {};
}

function initialiserVerrouCodePostal() {
  if (!window.ui) {
    setTimeout(initialiserVerrouCodePostal, 0);
    return;
  }
  const ui = window.ui || {};
  const formulaire = ui.formulaireCodePostal;
  const champ = ui.champCodePostalOverlay;
  if (!formulaire || !champ) {
    return;
  }
  if (formulaire.dataset.initialized === 'true') {
    return;
  }
  formulaire.dataset.initialized = 'true';

  const codeStocke = normaliserCodePostalLocal(lireCodePostalStocke());
  if (codeStocke) {
    masquerVerrouCodePostal();
    basculerIndicateurChargement(true);
    google.script.run
      .withSuccessHandler(res => {
        basculerIndicateurChargement(false);
        if (res && res.success) {
          definirCodePostalCourant(res.codePostal || codeStocke);
          masquerVerrouCodePostal();
        } else {
          effacerCodePostalStocke();
          afficherVerrouCodePostal(res && res.message ? res.message : "Ce code postal n'est pas desservi.");
        }
      })
      .withFailureHandler(() => {
        basculerIndicateurChargement(false);
        afficherVerrouCodePostal("Impossible de vÃ©rifier le code postal pour le moment.");
      })
      .verifierCodePostalAcces(codeStocke);
  } else {
    afficherVerrouCodePostal();
  }

  formulaire.addEventListener('submit', (event) => {
    event.preventDefault();
    const normalise = normaliserCodePostalLocal(champ.value);
    if (!normalise) {
      afficherErreurCodePostal("Merci de saisir un code postal Ã  5 chiffres.");
      champ.focus();
      return;
    }
    basculerIndicateurChargement(true);
    google.script.run
      .withSuccessHandler(res => {
        basculerIndicateurChargement(false);
        if (res && res.success) {
          definirCodePostalCourant(res.codePostal || normalise);
          masquerVerrouCodePostal();
        } else {
          effacerCodePostalStocke();
          afficherErreurCodePostal(res && res.message ? res.message : "Ce code postal n'est pas desservi.");
        }
      })
      .withFailureHandler(() => {
        basculerIndicateurChargement(false);
        afficherErreurCodePostal("Impossible de vÃ©rifier le code postal pour le moment.");
      })
      .verifierCodePostalAcces(normalise);
  });

  ui.btnModifierCodePostal?.addEventListener('click', () => {
    champ.value = window.etat.codePostalOfficine || '';
    afficherVerrouCodePostal();
  });
}

window.definirCodePostalCourant = definirCodePostalCourant;
window.obtenirCodePostalCourant = obtenirCodePostalCourant;

function initialiserTarifsResident() {
  const formatter = new Intl.NumberFormat('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const elStandard = document.getElementById('resident-mode-standard-prix');
  const elUrgence = document.getElementById('resident-mode-urgence-prix');
  const prixStandard = obtenirPrixResident('standard');
  const prixUrgence = obtenirPrixResident('urgence');
  if (elStandard) {
    elStandard.textContent = Number.isFinite(prixStandard) ? `${formatter.format(prixStandard)} ï¿½` : 'Forfait standard';
  }
  if (elUrgence) {
    elUrgence.textContent = Number.isFinite(prixUrgence) ? `${formatter.format(prixUrgence)} ï¿½` : 'Forfait urgence';
  }
}


/**
 * Affiche une notification Ã©phÃ©mÃ¨re.
 * @param {string} message
 * @param {('succes'|'info'|'erreur')} [type='succes']
 */
function afficherNotification(message, type = 'succes') {
  const conteneur = document.getElementById('conteneur-notifications');
  if (!conteneur) return;
  const notif = document.createElement('div');
  notif.className = `notification ${type}`;
  notif.setAttribute('role', 'alert');
  notif.textContent = message;
  conteneur.appendChild(notif);

  const dismiss = () => {
    if (!notif.parentNode) return;
    notif.classList.add('notification--closing');
    notif.removeEventListener('click', dismiss);
    notif.addEventListener('animationend', () => notif.remove(), { once: true });
  };

  notif.addEventListener('click', dismiss);
  setTimeout(dismiss, 5000);
}

/**
 * Affiche ou masque l'indicateur de chargement global.
 * @param {boolean} afficher - true pour afficher, false pour masquer.
 */
function basculerIndicateurChargement(afficher) {
  const indicateur = document.getElementById('indicateur-chargement');
  if (!indicateur) return;
  indicateur.classList.toggle('hidden', !afficher);
}

/**
 * Gestion d'erreur standardisÃ©e.
 * @param {any} erreur
 */
function afficherErreur(erreur) {
  basculerIndicateurChargement(false);
  const message = (erreur && erreur.message) ? erreur.message : String(erreur || 'Erreur inconnue');
  console.error('[ELS]', erreur);
  afficherNotification(`Erreur : ${message}`, 'erreur');
}

/**
 * Affiche le conteneur de finalisation et prÃ©-remplit les champs client.
 */
function afficherConteneurFinalisation() {
  const { ui } = window;
  const { clientReconnu, flags } = window.etat;

  if (flags && flags.clientPortalEnabled === false) return;

  if (clientReconnu) {
    ui.champEmailClient.value = clientReconnu.email;
    ui.champNomClient.value = clientReconnu.nom;
    ui.champAdresseClient.value = clientReconnu.adresse || '';
    if (ui.champTelephoneClient) {
      ui.champTelephoneClient.value = normaliserTelephoneLocal(clientReconnu.telephone || '');
      ui.champTelephoneClient.readOnly = false;
    }
    ui.champSiretClient.value = clientReconnu.siret || '';
    if (ui.champCodePostalClient) {
      const code = clientReconnu.codePostal || window.etat.codePostalOfficine || '';
      ui.champCodePostalClient.value = code;
      ui.champCodePostalClient.readOnly = true;
    }
    if (ui.champResidentClient) ui.champResidentClient.checked = !!clientReconnu.resident;
    ui.champEmailClient.readOnly = true;
    ui.champNomClient.readOnly = true;
  } else {
    // Ne pas effacer les champs si l'utilisateur est en train de saisir un nouvel email
    // pour Ã©viter de retomber sur un champ vide et la boucle de validation du navigateur.
    ui.champEmailClient.readOnly = false;
    ui.champNomClient.readOnly = false;
    if (ui.champTelephoneClient) {
      ui.champTelephoneClient.value = '';
      ui.champTelephoneClient.readOnly = false;
    }
    if (ui.champResidentClient) ui.champResidentClient.checked = false;
    if (ui.champCodePostalClient) {
      ui.champCodePostalClient.value = window.etat.codePostalOfficine || '';
      ui.champCodePostalClient.readOnly = true;
    }
  }

  mettreAJourEtatResident();

  ui.conteneurFinalisation.classList.remove('hidden');
  ui.champEmailClient.focus();
}

/**
 * DÃ©termine si le panier peut Ãªtre validÃ© automatiquement ou nÃ©cessite des informations complÃ©mentaires.
 * @param {Event} [ev]
 */
function initierValidationPanier(ev) {
  ev?.preventDefault?.();
  const { clientReconnu, panier } = window.etat;
  if (!obtenirCodePostalCourant()) {
    afficherNotification("Merci de valider le code postal de votre officine pour accÃ©der Ã  la rÃ©servation.", 'erreur');
    afficherVerrouCodePostal();
    return;
  }

  if (!panier || panier.length === 0) {
    afficherNotification("Votre panier est vide.", 'erreur');
    return;
  }

  if (clientReconnu && clientReconnu.email) {
    soumettreReservationClientReconnu();
  } else {
    afficherConteneurFinalisation();
  }
}

/**
 * Soumet la rÃ©servation en utilisant directement les informations du client reconnu.
 */
function soumettreReservationClientReconnu() {
  const { ui } = window;
  const { clientReconnu, panier } = window.etat;
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  const codePostal = obtenirCodePostalCourant();

  if (!codePostal) {
    afficherNotification("Merci de valider le code postal de votre officine avant de finaliser.", 'erreur');
    afficherVerrouCodePostal();
    return;
  }
  if (!clientReconnu || !clientReconnu.email) {
    afficherNotification("Identifiez-vous pour finaliser votre rÃ©servation.", 'erreur');
    afficherConteneurFinalisation();
    return;
  }

  if (!panier || panier.length === 0) {
    afficherNotification("Votre panier est vide.", 'erreur');
    return;
  }

  const email = String(clientReconnu.email).trim();
  if (!emailRegex.test(email)) {
    afficherNotification("Votre email enregistrÃ© nÃ©cessite une vÃ©rification. Merci de le confirmer.", 'erreur');
    afficherConteneurFinalisation();
    return;
  }

  if (ui.champEmailClient) {
    ui.champEmailClient.value = email;
    ui.champEmailClient.readOnly = true;
  }
  if (ui.champNomClient) {
    ui.champNomClient.value = clientReconnu.nom || '';
    ui.champNomClient.readOnly = true;
  }
  if (ui.champAdresseClient) {
    ui.champAdresseClient.value = clientReconnu.adresse || '';
  }
  if (ui.champSiretClient) {
    ui.champSiretClient.value = clientReconnu.siret || '';
  }
  if (ui.champCodePostalClient) {
    ui.champCodePostalClient.value = codePostal;
    ui.champCodePostalClient.readOnly = true;
  }
  if (ui.champResidentClient) {
    ui.champResidentClient.checked = !!clientReconnu.resident;
  }
  const telephoneChamp = ui.champTelephoneClient
    ? ui.champTelephoneClient.value
    : (clientReconnu.telephone || '');
  let telephoneNormalise = normaliserTelephoneLocal(telephoneChamp || clientReconnu.telephone || '');
  if (!telephoneNormalise && clientReconnu.telephone) {
    telephoneNormalise = normaliserTelephoneLocal(clientReconnu.telephone);
  }
  if (!telephoneValideLocal(telephoneNormalise)) {
    afficherNotification("Merci de renseigner un numÃ©ro de tÃ©lÃ©phone valide pour crÃ©er ou mettre Ã  jour votre accÃ¨s client.", 'erreur');
    if (ui.champTelephoneClient) {
      ui.champTelephoneClient.value = telephoneNormalise;
      ui.champTelephoneClient.focus();
    }
    afficherConteneurFinalisation();
    return;
  }
  if (ui.champTelephoneClient) {
    ui.champTelephoneClient.value = telephoneNormalise;
  }
  if (window.etat?.clientReconnu) {
    window.etat.clientReconnu.telephone = telephoneNormalise;
  }

  const residentActif = estForfaitResidentActif() || !!clientReconnu.resident;
  const modeResident = (typeof obtenirModeResident === 'function') ? obtenirModeResident() : 'standard';

  const donneesReservation = {
    client: {
      email: email,
      contactEmail: email,
      nom: clientReconnu.nom || '',
      adresse: clientReconnu.adresse || '',
      telephone: telephoneNormalise,
      siret: clientReconnu.siret || '',
      note: ui.champNoteReservation?.value.trim() || '',
      resident: residentActif,
      residentMode: modeResident,
      codePostal: codePostal
    },
    items: panier
  };

  soumettreReservation(donneesReservation);
}

function mettreAJourEtatResident() {
    const { ui } = window;
    const actif = estForfaitResidentActif();
    const affiliationReq = !!(window.configServeur && window.configServeur.RESIDENT_AFFILIATION_REQUIRED);
    ui.blocResidentDetails?.classList.toggle('hidden', !actif);
    ui.residentNoticeCreneau?.classList.toggle('hidden', !actif);
    if (ui.champEmailClient) {
      ui.champEmailClient.required = true;
      ui.champEmailClient.placeholder = actif
        ? (affiliationReq ? "Email de la structure (requis)" : "Email de la structure")
        : "";
    }
    if (ui.clientEmailHelper) {
      if (actif) {
        ui.clientEmailHelper.textContent = affiliationReq
          ? "Renseignez l'email de la structure : il servira Ã  recevoir l'identifiant d'accÃ¨s au portail client."
          : "Nous utiliserons l'email de la structure pour envoyer l'identifiant d'accÃ¨s client.";
      } else {
        ui.clientEmailHelper.textContent = "Cette adresse email est requise pour recevoir votre identifiant d'accÃ¨s client.";
      }
    }
    if (!actif) {
      (ui.residentModeRadios || []).forEach(radio => {
        if (radio.value === 'standard') radio.checked = true;
      });
    }
    if (typeof afficherPanier === 'function') {
      afficherPanier();
    }
    if (typeof mettreAJourRecapSelectionResident === 'function') {
      mettreAJourRecapSelectionResident();
    }
}

/**
 * Envoie les donnÃ©es de rÃ©servation au serveur.
 * @param {{client:Object,items:Array}} donneesReservation
 */
function soumettreReservation(donneesReservation) {
  const { ui } = window;
  const codePostalCourant = obtenirCodePostalCourant();
  if (!codePostalCourant) {
    afficherNotification("Merci de valider le code postal de votre officine avant de continuer.", 'erreur');
    afficherVerrouCodePostal();
    return;
  }
  if (donneesReservation && donneesReservation.client) {
    donneesReservation.client.codePostal = codePostalCourant;
  }

  function envoyer() {
    basculerIndicateurChargement(true);
    google.script.run
      .withSuccessHandler(reponse => {
        basculerIndicateurChargement(false);
        if (reponse.success) {
          afficherNotification("RÃ©servation confirmÃ©e ! Un email vous a Ã©tÃ© envoyÃ©.", 'succes');
          window.etat.panier = [];
          sauvegarderPanierDansLocalStorage();
          afficherPanier();
          ui.conteneurFinalisation.classList.add('hidden');
          memoriserClientReconnu(donneesReservation.client);
        } else {
          afficherErreur(reponse.summary || "Une erreur est survenue lors de la rÃ©servation.");
          if (reponse.failedItemIds && reponse.failedItemIds.length > 0) {
            window.etat.panier = window.etat.panier.filter(item => !reponse.failedItemIds.includes(item.id));
            sauvegarderPanierDansLocalStorage();
            afficherPanier();
          }
        }
      })
      .withFailureHandler(afficherErreur)
      .reserverPanier(donneesReservation);
  }

  envoyer();
}

/**
 * GÃ¨re la demande d'envoi de devis par email.
 */
function gererDemandeDevis() {
  const { ui } = window;
  const { panier, flags } = window.etat;

  if (flags?.devisEnabled === false) {
    afficherNotification('La demande de devis est dÃ©sactivÃ©e.', 'info');
    return;
  }

  if (panier.length === 0) {
    afficherNotification('Votre panier est vide.', 'erreur');
    return;
  }

  let email = ui.champEmailClient?.value.trim();
  if (!email && window.etat.clientReconnu) {
    email = window.etat.clientReconnu.email;
  }

  if (email) {
    envoyerDevis(email);
  } else {
    document.getElementById('modale-email-devis')?.classList.remove('hidden');
  }
}

/**
 * Collecte les donnÃ©es et appelle le serveur pour envoyer le devis.
 * @param {string} email
 */
function envoyerDevis(email) {
  const { ui } = window;
  const { panier, flags } = window.etat;

  if (flags?.devisEnabled === false) {
    afficherNotification('La demande de devis est dÃ©sactivÃ©e.', 'info');
    return;
  }

  basculerIndicateurChargement(true);

  const donneesDevis = {
    client: {
      email: email,
      nom: ui.champNomClient?.value.trim() || window.etat.clientReconnu?.nom || ''
    },
    items: panier
  };

  google.script.run
    .withSuccessHandler(reponse => {
      basculerIndicateurChargement(false);
      if (reponse.success) {
        afficherNotification(`Un devis a Ã©tÃ© envoyÃ© Ã  ${email}`, 'succes');
      } else {
        afficherErreur(reponse.error || "L'envoi du devis a Ã©chouÃ©.");
      }
    })
    .withFailureHandler(afficherErreur)
    .envoyerDevisParEmail(donneesDevis);
}

/**

 * GÃ¨re la soumission du formulaire de rÃ©servation final.
 * @param {SubmitEvent} e
 */
function gererSoumissionReservation(e) {
  e.preventDefault();
  const { ui } = window;
  const { panier } = window.etat;
  const codePostal = obtenirCodePostalCourant();

  if (panier.length === 0) {
    afficherNotification("Votre panier est vide.", 'erreur');
    return;
  }

  if (!codePostal) {
    afficherNotification("Merci de valider le code postal de votre officine avant de finaliser.", 'erreur');
    afficherVerrouCodePostal();
    return;
  }

  const emailSaisi = ui.champEmailClient.value.trim();
  const emailClient = (emailSaisi || window.etat.clientReconnu?.email || '').trim();
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  const isResident = estForfaitResidentActif();
  const residentMode = obtenirModeResident();
  if (!emailClient) {
    afficherNotification('Merci de renseigner une adresse email valide pour recevoir votre identifiant.', 'erreur');
    ui.champEmailClient.focus();
    return;
  }
  if (!emailRegex.test(emailClient)) {
    afficherNotification("Veuillez fournir une adresse email valide.", 'erreur');
    ui.champEmailClient.focus();
    return;
  }
  let telephoneClient = ui.champTelephoneClient ? normaliserTelephoneLocal(ui.champTelephoneClient.value) : '';
  if (!telephoneClient && window.etat.clientReconnu?.telephone) {
    telephoneClient = normaliserTelephoneLocal(window.etat.clientReconnu.telephone);
    if (ui.champTelephoneClient && telephoneClient) {
      ui.champTelephoneClient.value = telephoneClient;
    }
  }
  if (!telephoneValideLocal(telephoneClient)) {
    afficherNotification("Merci de renseigner un numÃ©ro de tÃ©lÃ©phone valide pour organiser le retrait.", 'erreur');
    if (ui.champTelephoneClient) {
      ui.champTelephoneClient.focus();
    }
    return;
  }
  if (ui.champTelephoneClient) {
    ui.champTelephoneClient.value = telephoneClient;
  }
  if (window.etat.clientReconnu) {
    window.etat.clientReconnu.telephone = telephoneClient;
  }
  if (!emailSaisi) {
    ui.champEmailClient.value = emailClient;
  }
  if (ui.champCodePostalClient) {
    ui.champCodePostalClient.value = codePostal;
    ui.champCodePostalClient.readOnly = true;
  }

  const donneesReservation = {
    client: {
      email: emailClient,
      contactEmail: emailClient,
      nom: ui.champNomClient.value.trim(),
      adresse: ui.champAdresseClient.value.trim(),
      telephone: telephoneClient,
      siret: ui.champSiretClient.value.trim(),
      note: ui.champNoteReservation.value.trim(),
      resident: isResident,
      residentMode: residentMode,
      codePostal: codePostal
    },
    items: panier
  };
  if (window.etat.flags.adresseAutocompleteEnabled && window.etat.adresseSuggestion) {
    const selection = window.etat.adresseSuggestion;
    if (selection && selection.label && selection.label === donneesReservation.client.adresse) {
      donneesReservation.client.adresseSuggestion = selection;
    }
  }

  soumettreReservation(donneesReservation);
}

/**
 * Affiche ou masque le bouton "Vider Panier" et gÃ¨re son Ã©couteur.
 */
function mettreAJourBoutonViderPanier() {
  const { ui } = window;

  ui.btnViderPanier?.removeEventListener('click', viderPanier);
  if (window.etat.flags.cartResetEnabled) {
    ui.btnViderPanier?.classList.remove('hidden');
    ui.btnViderPanier?.addEventListener('click', viderPanier);
  } else {
    ui.btnViderPanier?.classList.add('hidden');
  }
}

/**
 * Configure tous les Ã©couteurs d'Ã©vÃ©nements de l'application.
 */
function configurerEcouteursEvenements() {
  const { ui } = window;

  // GÃ¨re les clics sur les jours du calendrier.
  ui.grilleCalendrier?.addEventListener('click', (e) => {
    const jourClique = e.target.closest('.jour-calendrier');
    if (jourClique && !jourClique.classList.contains('desactive')) {
      const dateString = jourClique.dataset.date;
      if(dateString) {
        ouvrirConfigurationTournee(dateString);
      }
    }
  });

  // Navigation du calendrier
  ui.btnMoisPrecedent?.addEventListener('click', () => changerMois(-1));
  ui.btnMoisSuivant?.addEventListener('click', () => changerMois(1));

  // Ã‰couteur pour le formulaire de configuration de tournÃ©e
  ui.formulaireConfigTournee?.addEventListener('submit', gererDemandeCreneaux);

  // Actions de la modale de configuration (Modale 1)
  ui.btnFermerConfigTournee?.addEventListener('click', () => ui.modaleConfigTournee.classList.add('hidden'));
  ui.btnAjouterArret?.addEventListener('click', () => {
    ui.valeurArretsSup.textContent = parseInt(ui.valeurArretsSup.textContent) + 1;
    mettreAJourResumeTournee();
  });
  ui.btnRetirerArret?.addEventListener('click', () => {
    const valeur = parseInt(ui.valeurArretsSup.textContent);
    if (valeur > 1) {
      ui.valeurArretsSup.textContent = valeur - 1;
      mettreAJourResumeTournee();
    }
  });
  ui.interrupteurRetour?.addEventListener('change', mettreAJourResumeTournee);

  // Actions de la modale de sÃ©lection de crÃ©neau (Modale 2)
  ui.btnFermerSelectionCreneau?.addEventListener('click', () => ui.modaleSelectionCreneau.classList.add('hidden'));
  ui.btnAjouterAuPanier?.addEventListener('click', gererAjoutAuPanier);
  ui.btnModifierTournee?.addEventListener('click', retourVersConfiguration);

  // Ã‰couteurs pour la modale de confirmation de rÃ©currence (Modale 3)
  const modaleRecurrence = document.getElementById('modale-confirmation-recurrence');
  document.getElementById('btn-confirmer-recurrence')?.addEventListener('click', confirmerEtAjouterRecurrenceAuPanier);
  document.getElementById('btn-fermer-confirmation-recurrence')?.addEventListener('click', () => modaleRecurrence.classList.add('hidden'));
  document.getElementById('btn-annuler-recurrence')?.addEventListener('click', () => modaleRecurrence.classList.add('hidden'));

  // Actions du panier et de la finalisation
  ui.btnValiderPanier?.addEventListener('click', initierValidationPanier);
  document.getElementById('btn-envoyer-devis')?.addEventListener('click', gererDemandeDevis);
  ui.formulaireReservation?.addEventListener('submit', gererSoumissionReservation);
  ui.btnAnnulerReservation?.addEventListener('click', () => ui.conteneurFinalisation.classList.add('hidden'));
  ui.listePanier?.addEventListener('click', gererActionsPanier);
  mettreAJourBoutonViderPanier();

  ui.champResidentClient?.addEventListener('change', mettreAJourEtatResident);
  (ui.residentModeRadios || []).forEach(radio => {
    radio.addEventListener('change', () => {
      if (estForfaitResidentActif()) mettreAJourEtatResident();
    });
  });

  // Ã‰couteurs pour la modale de demande d'email pour le devis
  const modaleEmailDevis = document.getElementById('modale-email-devis');
  document.getElementById('formulaire-email-devis')?.addEventListener('submit', (e) => {
      e.preventDefault();
      const emailInput = document.getElementById('email-pour-devis');
      if (emailInput && emailInput.value) {
          envoyerDevis(emailInput.value.trim());
          modaleEmailDevis.classList.add('hidden');
          emailInput.value = '';
      }
  });
  document.getElementById('btn-fermer-email-devis')?.addEventListener('click', () => {
      modaleEmailDevis.classList.add('hidden');
  });

  // Gestion du client
  // Suppression de la recherche auto au blur pour Ã©viter de rÃ©ouvrir/rafraÃ®chir le formulaire
  // pendant que l'utilisateur saisit un nouvel email. La connexion explicite se fait via le bouton.
  ui.btnChangerClient?.addEventListener('click', reinitialiserClient);
  ui.btnConnexionClient?.addEventListener('click', demanderConnexionClient);
  const lienEspaceClient = document.getElementById('btn-espace-client');
  if (lienEspaceClient) {
    lienEspaceClient.addEventListener('click', (e) => {
      if (!window.etat?.clientReconnu) {
        e.preventDefault();
        if (typeof afficherNotification === 'function') {
          afficherNotification("Aucun compte client trouvÃ©. Veuillez valider une rÃ©servation pour crÃ©er votre compte.", 'info');
        }
        if (typeof afficherConteneurFinalisation === 'function') {
          afficherConteneurFinalisation();
        }
        return;
      }
      if (typeof notifierPremiereConnexionClient === 'function') {
        notifierPremiereConnexionClient();
      }
    });
  }
  const btnReloadEspaceClient = document.getElementById('btn-recharger-espace-client');
  if (btnReloadEspaceClient) {
    btnReloadEspaceClient.addEventListener('click', () => {
      if (typeof rechargerEspaceClientInline === 'function') {
        rechargerEspaceClientInline();
      }
    });
  }
}

function focusCalendrier() {
  const panel = document.getElementById('calendar-panel');
  if (!panel) return null;
  try {
    panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
  } catch (_err) {
    const top = panel.getBoundingClientRect().top + window.scrollY;
    window.scrollTo({ top: Math.max(top - 16, 0), behavior: 'smooth' });
  }
  panel.classList.add('tarif-highlight');
  window.setTimeout(() => panel.classList.remove('tarif-highlight'), 1200);
  return panel;
}

function declencherActionTarif(element) {
  if (!element) return;
  const action = element.getAttribute('data-tarif-action') || '';
  const variant = element.getAttribute('data-tarif-variant') || '';
  focusCalendrier();

  if (action === 'tournee' && (variant === 'normal' || variant === 'samedi' || variant === 'urgent')) {
    proposerPremiereCourseParVariant(variant, { ouvrirWhatsapp: false });
    return;
  }

  if (action === 'resident') {
    if (window.ui?.champResidentClient && !window.ui.champResidentClient.checked) {
      window.ui.champResidentClient.checked = true;
      mettreAJourEtatResident();
    }
    if (variant) {
      const radio = document.getElementById(`resident-mode-${variant}`);
      if (radio) {
        radio.checked = true;
        radio.dispatchEvent(new Event('change', { bubbles: true }));
      }
    }
    afficherConteneurFinalisation();
    afficherNotification("Forfait rÃ©sident sÃ©lectionnÃ©. ComplÃ©tez vos informations pour finaliser.", 'info');
    return;
  }

  window.etat.tarifChoisi = {
    type: variant || action,
    horodatage: Date.now()
  };
  afficherNotification("Choisissez un crÃ©neau dans le calendrier pour poursuivre avec ce tarif.", 'info');
}

function initialiserActionsTarifs() {
  const elements = document.querySelectorAll('[data-tarif-action]');
  if (!elements.length) return;
  elements.forEach(element => {
    const trigger = () => declencherActionTarif(element);
    element.addEventListener('click', trigger);
    element.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        trigger();
      }
    });
  });
}


function initialiserBoutonUrgentAide() {
  const btn = document.getElementById('btn-urgent-aide');
  if (!btn) return;
  const trigger = (event) => {
    event?.stopPropagation?.();
    focusCalendrier();
    proposerPremiereCourseParVariant('urgent', { ouvrirWhatsapp: true });
  };
  btn.addEventListener('click', trigger);
  btn.addEventListener('keydown', (event) => {
    if (event.key === 'Enter' || event.key === ' ') {
      event.preventDefault();
      trigger(event);
    }
  });
}

/**
 * Point d'entrÃ©e principal, exÃ©cutÃ© aprÃ¨s le chargement du DOM.
 */
document.addEventListener('DOMContentLoaded', () => {
  initialiserVerrouCodePostal();
  google.script.run.withSuccessHandler(cfg => {
    window.etat.flags = initializeFlags(cfg);
    try {
      if (window.etat.flags && window.etat.flags.elsUiThemingEnabled) {
        document.body.classList.add('els-ui-theming');
        if (!document.body.classList.contains('theme-ultra')) {
          document.body.classList.add('els-aluminium');
        }
      }
    } catch (e) { /* no-op */ }
    initialiserThemeSwitcher();
    initialiserTarifsResident();
    if (typeof initialiserAdresseAutocompleteClient === 'function') {
      initialiserAdresseAutocompleteClient();
    }
    mettreAJourEtatResident();
    mettreAJourBoutonViderPanier();
    configurerEcouteursEvenements();
    initialiserActionsTarifs();
    initialiserBoutonUrgentAide();
  }).getConfiguration();
  chargerPanierDepuisLocalStorage();
  verifierSessionClient();
  afficherCalendrier(window.etat.dateActuelle.getMonth() + 1, window.etat.dateActuelle.getFullYear());
});

/**
 * Change le mois affichÃ© dans le calendrier.
 * @param {number} delta - Le changement de mois (-1 pour prÃ©cÃ©dent, 1 pour suivant).
 */
function changerMois(delta) {
    window.etat.dateActuelle.setMonth(window.etat.dateActuelle.getMonth() + delta);
    afficherCalendrier(window.etat.dateActuelle.getMonth() + 1, window.etat.dateActuelle.getFullYear());
}

function isoDateLocale(date) {
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const d = String(date.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}

function extraireHeureCreneau(slot) {
  if (!slot) return '';
  if (typeof slot === 'string') return slot;
  if (typeof slot === 'object') {
    if (slot.time) return slot.time;
    if (slot.creneau) return slot.creneau;
  }
  return String(slot);
}

function demanderCreneauxPourDate(dateISO, duree, autresCoursesPanier = []) {
  return new Promise((resolve, reject) => {
    google.script.run
      .withSuccessHandler(creneaux => resolve(Array.isArray(creneaux) ? creneaux : []))
      .withFailureHandler(reject)
      .obtenirCreneauxDisponiblesPourDate(dateISO, duree, null, null, autresCoursesPanier);
  });
}


function ouvrirWhatsappUrgent() {
  const anchor = document.querySelector('.cta-whatsapp');
  const baseHref = (anchor && anchor.getAttribute('href')) ? anchor.getAttribute('href') : 'https://wa.me/33768591888';
  const separator = baseHref.includes('?') ? '&' : '?';
  const message = "Bonjour, j'ai une livraison urgente à réserver via ELS.";
  const url = `${baseHref}${separator}text=${encodeURIComponent(message)}`;
  try {
    window.open(url, '_blank', 'noopener');
  } catch (_err) {
    window.location.href = url;
  }
}

async function proposerPremiereCourseParVariant(variant, options = {}) {
  const typeMapping = { normal: 'Normal', samedi: 'Samedi', urgent: 'Urgent' };
  const typeRecherche = typeMapping[variant] || 'Normal';
  const maxJoursRecherche = variant === 'urgent' ? 10 : 30;
  const totalStops = 1;
  const returnToPharmacy = false;
  const dureeBase = parseInt(configServeur?.DUREE_BASE, 10) || 30;
  const aujourdHui = new Date();
  const ouvrirWhatsapp = options && options.ouvrirWhatsapp === true;
  basculerIndicateurChargement(true);
  try {
    let resultat = null;
    for (let i = 0; i < maxJoursRecherche; i++) {
      const dateCandidate = new Date(aujourdHui);
      dateCandidate.setDate(aujourdHui.getDate() + i);
      if (dateCandidate.getDay() === 0) {
        continue; // pas de dimanche
      }
      if (variant === 'samedi' && dateCandidate.getDay() !== 6) {
        continue; // on saute jusqu'au samedi suivant
      }
      const dateISO = isoDateLocale(dateCandidate);
      const dispoLocale = window.etat?.donneesCalendrier?.[dateISO];
      if (dispoLocale && dispoLocale.disponibles === 0) {
        continue;
      }
      const autresCoursesPanier = (window.etat?.panier || [])
        .filter(item => item.date === dateISO)
        .map(item => ({ startTime: item.startTime, duree: item.duree }));
      let creneaux = [];
      try {
        creneaux = await demanderCreneauxPourDate(dateISO, dureeBase, autresCoursesPanier);
      } catch (_err) {
        continue;
      }
      if (!creneaux.length) {
        continue;
      }
      const slotChoisi = creneaux.find(creneau => {
        const slotTime = extraireHeureCreneau(creneau);
        const estimation = calculerInfosTourneeClient(totalStops, returnToPharmacy, dateISO, slotTime);
        return estimation.typeCourse === typeRecherche;
      });
      if (slotChoisi) {
        resultat = { dateISO, creneaux, slot: slotChoisi };
        break;
      }
    }

    if (!resultat) {
      afficherNotification(`Aucune course au tarif ${typeRecherche} n'est disponible dans les prochains jours. Choisissez un autre créneau.`, 'info');
      return;
    }

    const slotTime = extraireHeureCreneau(resultat.slot);
    const estimation = calculerInfosTourneeClient(totalStops, returnToPharmacy, resultat.dateISO, slotTime);
    window.etat.tourneeEnCours = {
      date: resultat.dateISO,
      totalStops,
      returnToPharmacy,
      duree: estimation.duree
    };
    window.etat.tarifChoisi = { type: variant || typeRecherche.toLowerCase(), horodatage: Date.now() };

    afficherSelectionCreneaux(resultat.creneaux);
    setTimeout(() => {
      const btn = window.ui?.grilleSelectionCreneau?.querySelector(`[data-creneau="${slotTime}"]`);
      if (btn && !btn.disabled && !btn.classList.contains('indispo')) {
        btn.click();
      }
    }, 20);

    const dateLisible = new Date(resultat.dateISO + 'T00:00:00').toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
    afficherNotification(`Proposition : ${dateLisible} à ${slotTime} (tarif ${typeRecherche}).`, 'info');

    if (variant === 'urgent' && ouvrirWhatsapp) {
      ouvrirWhatsappUrgent();
    }
  } catch (err) {
    afficherErreur(err);
  } finally {
    basculerIndicateurChargement(false);
  }
}

</script>
